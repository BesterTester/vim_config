" =========================
" KEY TO FUNCTION MAPPINGS
" =========================

" Programming specific mappings
execute 'nnoremap ' . g:prog_leader . 'b :call CompileAndRunVSplit()<CR>'
execute 'nnoremap ' . g:prog_leader . 'r :call RerunInVSplit()<CR>'
execute 'nnoremap ' . g:prog_leader . 'c :call ToggleComment()<CR>'
execute 'vnoremap ' . g:prog_leader . 'c :call ToggleComment()<CR>'


" =========================
" FUNCTIONS
" =========================

let g:out_esc       = ''

" Save the current buffer and run the gcc compiler with the file
function! CompileC()
    update
    let g:filename = expand('%:p:r')
    let compile_cmd = 'gcc ' . shellescape(expand('%:p')) . ' -o ' . shellescape(g:filename) . " -lm"
    echo "Compiling: " . compile_cmd
    let result = system(compile_cmd)
    if v:shell_error == 0
        echo "Compilation successful. Running..."
        execute 'vertical rightbelow terminal ' . g:filename
    else
        echo "Compilation failed!"
        echo result
    endif
endfunction


" Rerun the last compiled C program
function! ReRunC()
    if exists('g:filename') && !empty(g:filename)
        execute 'quit'
        execute 'vertical rightbelow terminal ' . g:filename
    else
        echo "Could not execute file: " . g:filename
    endif
endfunction


function! CompileAndRunVSplit()
    update
    let l:src           = expand('%:p')
    let l:src_esc       = shellescape(l:src)
    let l:out           = expand('%:p:r')
    let g:out_esc       = shellescape(l:out)
    let l:compile_cmd   = 'bash -lc "gcc  ' . l:src_esc . ' -o ' . g:out_esc . ' -lm && ' . g:out_esc . '"'
    execute 'vertical rightbelow terminal ' . l:compile_cmd
endfunction


function! RerunInVSplit()
    "   update
    "   let l:src           = expand('%:p')
    "   let l:src_esc       = shellescape(l:src)
    "   let l:out           = expand('%:p:r')
    "   let g:out_esc       = shellescape(l:out)
    let l:rerun_cmd   = 'bash -lc "' . g:out_esc . '"'
    execute 'quit'
    execute 'vertical rightbelow terminal ' . l:rerun_cmd
endfunction


" Toggle C/C++ comment on single line or visual range
function! ToggleComment() range
  " Toggle comment on a single line or a visual range
  let l:start = a:firstline
  let l:end = a:lastline
  for lnum in range(l:start, l:end)
    let ltxt = getline(lnum)
    if substitute(ltxt, '\s*', '', '') ==# ''
      " skip empty lines
      continue
    endif
    let lstripped = substitute(ltxt, '^\s*', '', '')
    if lstripped =~# '^//'
      " Uncomment this line
      let lnew = substitute(ltxt, '^\(\s*\)//\s*', '\1', '')
      call setline(lnum, lnew)
    else
      " Comment this line
      let lindent = matchstr(ltxt, '^\s*')
      call setline(lnum, lindent . '// ' . lstripped)
    endif
  endfor
  if l:start == l:end
    echo "Toggled comment on line " . l:start
  else
    echo "Toggled comments for lines " . l:start . "-" . l:end
  endif
endfunction

